<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TDA7416 Control</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #007bff; --text: #fff; --text-sec: #888; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; user-select: none; }
        .header { padding: 15px; background: #1a1a1a; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .status { font-size: 0.8rem; color: #f44336; }
        .status.ok { color: #00e676; }
        .tabs { display: flex; overflow-x: auto; background: #252525; }
        .tab-btn { flex: 1; padding: 15px; background: none; border: none; color: #aaa; font-size: 1rem; cursor: pointer; border-bottom: 2px solid transparent; min-width: 80px; }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: bold; }
        .content { display: none; padding: 20px; padding-bottom: 80px; }
        .content.active { display: block; }
        .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        h3 { margin-top: 0; font-size: 1.1rem; color: #ddd; border-bottom: 1px solid #333; padding-bottom: 5px; }
        label { display: block; margin-bottom: 5px; color: var(--text-sec); font-size: 0.9rem; }
        input[type=range] { width: 100%; height: 6px; background: #444; border-radius: 5px; outline: none; -webkit-appearance: none; margin: 15px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--accent); border-radius: 50%; cursor: pointer; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        select { background: #333; color: white; border: none; padding: 8px; border-radius: 5px; width: 100%; font-size: 1rem; }
        .btn-toggle { background: #333; color: #aaa; padding: 10px 20px; border-radius: 20px; border: 1px solid #444; cursor: pointer; flex: 1; margin: 0 5px; }
        .btn-toggle.active { background: var(--accent); color: white; border-color: var(--accent); }
        .eq-scroll { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; }
        .eq-band { min-width: 85px; text-align: center; background: #252525; padding: 10px; border-radius: 8px; display: flex; flex-direction: column; gap: 8px; align-items: center; }
        .btn-step { background: #444; color: white; border: none; width: 100%; padding: 10px 0; border-radius: 5px; font-size: 1.2rem; font-weight: bold; }
        .btn-step:active { background: var(--accent); }
        .gain-val { font-size: 1.2rem; color: var(--accent); font-weight: bold; min-width: 35px; }
        .freq-toggle { font-size: 0.7rem; background: #333; border: 1px solid #555; color: #ccc; border-radius: 4px; padding: 2px 4px; cursor: pointer; width: 100%; }
        .q-select { font-size: 0.8rem; background: #1a1a1a; color: #00e676; border: 1px solid #444; border-radius: 4px; width: 100%; }
        #balCanvas { background: #2b2b2b; border-radius: 10px; margin: 0 auto; display: block; touch-action: none; border: 2px solid #444; }
        #connectBtn { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <div id="status" class="status">Disconnected</div>
        <button id="connectBtn">Connect</button>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('main')">Main</button>
        <button class="tab-btn" onclick="openTab('eq')">EQ</button>
        <button class="tab-btn" onclick="openTab('bal')">Balance</button>
        <button class="tab-btn" onclick="openTab('adv')">Advanced</button>
    </div>

    <div id="main" class="content active">
        <div class="card">
            <h3>Master Volume</h3>
            <h2 id="volVal" style="text-align: center; color: var(--accent);">-20</h2>
            <input type="range" id="volSlider" min="-159" max="40" value="-20" oninput="send('voll', this.value); document.getElementById('volVal').innerText = this.value">
        </div>
        <div class="card">
            <h3>Input Source</h3>
            <div style="display: flex;">
                <button id="btnSrcBT" class="btn-toggle" onclick="setInput('Bluetooth')">Bluetooth</button>
                <button id="btnSrcUSB" class="btn-toggle" onclick="setInput('USB')">USB</button>
            </div>
        </div>
        <div class="card">
            <h3>Preamp Gain</h3>
            <input type="range" id="preSlider" min="0" max="15" value="10" oninput="send('pre', this.value)">
        </div>
        <div class="card">
            <div class="row">
                <h3>Mute</h3>
                <label>
                    <input type="checkbox" id="muteSw" onchange="send('mute', this.checked ? 0 : 1)" checked>
                    <span id="muteLabel">Sound ON</span>
                </label>
            </div>
        </div>
    </div>

    <div id="eq" class="content">
        <div class="eq-scroll" id="eqContainer"></div>
        <div class="card">
            <h3>Subwoofer Config</h3>
            <div class="row"><label>Freq</label><select onchange="send('s_fr', this.value)" id="subFr"><option value="0">Off</option><option value="1">90Hz</option><option value="2">135Hz</option><option value="3">180Hz</option><option value="4">225Hz</option></select></div>
            <div class="row"><label>Q-Factor</label><select onchange="send('s_q', this.value)" id="subQ"><option value="0">3.5</option><option value="1">1.8</option></select></div>
            <div class="row"><label>HPF</label><select onchange="send('s_hpc', this.value)" id="subHpc"><option value="0">90Hz</option><option value="1">135Hz</option><option value="2">180Hz</option><option value="3">225Hz</option></select></div>
            <div class="row"><label>HP Filter</label><input type="checkbox" id="subHp" onchange="send('s_hp', this.checked?1:0)"></div>
            <div class="row"><label>DC Coup</label><input type="checkbox" id="subCp" onchange="send('s_coup', this.checked?1:0)"></div>
        </div>
    </div>

    <div id="bal" class="content">
        <div class="card"><h3>Subwoofer Gain</h3><input type="range" id="subAttSlider" min="-79" max="15" value="0" oninput="send('s_att', this.value)"></div>
        <div class="card" style="text-align: center;"><h3>Fader / Balance</h3><canvas id="balCanvas" width="300" height="300"></canvas><p style="font-size: 0.8rem; margin-top: 5px;">Drag to adjust</p></div>
    </div>

    <div id="adv" class="content">
        <div class="card">
            <h3>Loudness</h3>
            <div class="row"><label>Enable (Bypass Off)</label><input type="checkbox" id="lByp" onchange="send('l_byp', this.checked?1:0)"></div>
            <label>Attenuation</label><input type="range" id="lAttSlider" min="0" max="19" value="19" oninput="send('l_att', this.value)">
            <label>Center Freq</label><select onchange="send('l_cen', this.value)" id="lCen"><option value="0">200Hz</option><option value="1">400Hz</option><option value="2">600Hz</option><option value="3">800Hz</option></select>
            <div class="row"><label>Front Coupling DC</label><input type="checkbox" id="frontCp" onchange="send('f_coup', this.checked?1:0)"></div>
            <div class="row"><label>Rear Equalizing Effect</label><input type="checkbox" id="rearEf" onchange="send('r_eff', this.checked?1:0)"></div>
        </div>
    </div>

    <div class="card" style="margin: 20px;">
        <h3>Debug Log</h3>
        <div id="debugLog" style="height: 100px; overflow-y: auto; font-family: monospace; font-size: 0.7rem; background: #000; color: #0f0; padding: 5px; border-radius: 5px;">Waiting for data...</div>
    </div>

    <script>
    let port, writer, isSyncing = false;
    let serialBuffer = "";
    let localEqGains = [0, 0, 0, 0, 0, 0, 0];

    function log(msg) {
        const div = document.getElementById('debugLog');
        if(div) { div.innerHTML += "<div>" + msg + "</div>"; div.scrollTop = div.scrollHeight; }
    }

    class USBSerialDevice {
        constructor(device) { this.device = device; this.interface = 0; }
        async open() {
            await this.device.open();
            if (this.device.configuration === null) await this.device.selectConfiguration(1);
            const iface = this.device.configuration.interfaces.find(i => i.alternates[0].endpoints && i.alternates[0].endpoints.length > 1) || this.device.configuration.interfaces[0];
            this.interface = iface.interfaceNumber;
            await this.device.claimInterface(this.interface);
            const endpoints = iface.alternates[0].endpoints;
            this.epIn = endpoints.find(e => e.direction === 'in').endpointNumber;
            this.epOut = endpoints.find(e => e.direction === 'out').endpointNumber;

            // CP2102 Baud Rate 115200
            await this.device.controlTransferOut({requestType:'vendor', recipient:'interface', request:0x00, value:1, index:this.interface});
            const baud = 115200;
            const data = new Uint8Array([baud & 0xff, (baud >> 8) & 0xff, (baud >> 16) & 0xff, (baud >> 24) & 0xff]);
            await this.device.controlTransferOut({requestType:'vendor', recipient:'interface', request:0x1E, value:0, index:this.interface}, data);
            await this.device.controlTransferOut({requestType:'vendor', recipient:'interface', request:0x07, value:0x0303, index:this.interface});

            this.readable = { getReader: () => ({ read: async () => {
                const result = await this.device.transferIn(this.epIn, 64);
                return { value: new Uint8Array(result.data.buffer), done: false };
            }, releaseLock: () => {} }) };
            this.writable = { getWriter: () => ({ write: async (data) => { await this.device.transferOut(this.epOut, data); }, releaseLock: () => {} }) };
        }
    }

    window.addEventListener('load', () => { generateEQ(); initBalancePad(); });

    document.getElementById('connectBtn').onclick = async function() {
        try {
            const device = await navigator.usb.requestDevice({ filters: [] });
            port = new USBSerialDevice(device);
            await port.open();
            document.getElementById('status').innerText = "Connected";
            document.getElementById('status').className = "status ok";
            this.style.display = 'none';
            writer = port.writable.getWriter();
            setTimeout(() => sendRaw("DUMP"), 1000);
            readLoop();
        } catch (e) { log("Error: " + e.message); }
    };

    async function readLoop() {
        const reader = port.readable.getReader();
        try {
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                const text = new TextDecoder().decode(value);
                processIncoming(text);
            }
        } catch (e) { log("Read Error: " + e.message); }
    }

    function processIncoming(text) {
        serialBuffer += text;
        let lines = serialBuffer.split('\n');
        serialBuffer = lines.pop();
        for (let line of lines) {
            line = line.trim();
            if (line.startsWith("STATE:")) {
                log("SYNC: " + line);
                parseState(line);
            } else {
                log("RX: " + line);
            }
        }
    }

    function parseState(line) {
        isSyncing = true;
        try {
            const raw = line.replace("STATE:", "").replace(",END", "").trim();
            const d = raw.split(","); // Нарезаем строку на массив
            
            // 0:voll, 1:ins, 2:pre, 3:mute
            document.getElementById('volVal').innerText = d[0];
            document.getElementById('volSlider').value = d[0];
            setInput(d[1] == 2 ? 'Bluetooth' : 'USB', false);
            document.getElementById('preSlider').value = d[2];
            document.getElementById('muteSw').checked = (d[3] == "0");
            document.getElementById('muteLabel').innerText = (d[3] == "0") ? "Sound ON" : "Sound OFF";

            // 4-10: EQ Gains
            for(let i=0; i<7; i++) {
                localEqGains[i] = parseInt(d[4+i]);
                if(document.getElementById(`gv${i}`)) 
                    document.getElementById(`gv${i}`).innerText = (localEqGains[i] > 0 ? "+" : "") + localEqGains[i];
            }

            // 11-17: EQ Q-Factors
            for(let i=0; i<7; i++) {
                let qSel = document.getElementById(`eqq_sel${i}`);
                if(qSel) qSel.value = d[11+i];
            }

            // 18-20: EQ Frequencies (ef0, ef1, ef2)
            if(document.getElementById('eqf_sel0')) document.getElementById('eqf_sel0').value = d[18];
            if(document.getElementById('eqf_sel5')) document.getElementById('eqf_sel5').value = d[19];
            if(document.getElementById('eqf_sel6')) document.getElementById('eqf_sel6').value = d[20];

            // 21-25: Subwoofer Config
            document.getElementById('subFr').value = d[21];
            document.getElementById('subQ').value = d[22];
            document.getElementById('subHp').checked = (d[23] == "1");
            document.getElementById('subHpc').value = d[24];
            document.getElementById('subCp').checked = (d[25] == "1");

            // 30: Sub Attenuator
            document.getElementById('subAttSlider').value = d[30];

            // 31-34: Loudness
            document.getElementById('lByp').checked = (d[31] == "1");
            document.getElementById('lAttSlider').value = d[32];
            document.getElementById('lCen').value = d[33];

            // 35-36: Advanced
            document.getElementById('frontCp').checked = (d[35] == "1");
            document.getElementById('rearEf').checked = (d[36] == "1");

            // Баланс (26-29) - отрисовка точки
            drawBalanceFromState(parseInt(d[26]), parseInt(d[27]), parseInt(d[28]), parseInt(d[29]));

        } catch(e) { log("Parse Error: " + e.message); }
        isSyncing = false;
    }

    async function sendRaw(text) {
        if (writer) {
            await writer.write(new TextEncoder().encode(text + "\r\n"));
            log("TX: " + text);
        }
    }

    async function send(key, val) {
        if (isSyncing) return;
        sendRaw(`${key}:${Math.floor(val)}`);
    }

    function setInput(type, transmit=true) {
        document.getElementById('btnSrcBT').className = `btn-toggle ${type==='Bluetooth'?'active':''}`;
        document.getElementById('btnSrcUSB').className = `btn-toggle ${type==='USB'?'active':''}`;
        if (transmit) send('ins', type === 'Bluetooth' ? 2 : 0);
    }

    function openTab(id) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if (event && event.target) event.target.classList.add('active');
    }

    function generateEQ() {
        const container = document.getElementById('eqContainer');
        container.innerHTML = '';
        for (let i = 0; i < 7; i++) {
            const div = document.createElement('div');
            div.className = 'eq-band';
            let freqHTML = '<div style="height:25px"></div>'; 
            if (i === 0) freqHTML = `<select id="eqf_sel0" class="freq-toggle" onchange="send('eqf0', this.value)"><option value="0">62Hz</option><option value="1">100Hz</option></select>`;
            else if (i === 5) freqHTML = `<select id="eqf_sel5" class="freq-toggle" onchange="send('eqf5', this.value)"><option value="0">4kHz</option><option value="1">6.3kHz</option></select>`;
            else if (i === 6) freqHTML = `<select id="eqf_sel6" class="freq-toggle" onchange="send('eqf6', this.value)"><option value="0">15kHz</option><option value="1">16kHz</option></select>`;

            div.innerHTML = `<div style="font-size:0.7rem; font-weight:bold;">Band ${i+1}</div>${freqHTML}
                <button class="btn-step" onclick="changeGain(${i}, 1)">+</button>
                <div class="gain-val" id="gv${i}">0</div>
                <button class="btn-step" onclick="changeGain(${i}, -1)">-</button>
                <label style="font-size:0.6rem; margin-top:5px; color:#888;">Q-Factor</label>
                <select id="eqq_sel${i}" class="q-select" onchange="send('eqq${i}', this.value)">
                    <option value="0">2.2</option><option value="1" selected>1.8</option><option value="2">1.4</option><option value="3">1.0</option>
                </select>`;
            container.appendChild(div);
        }
    }

    function changeGain(idx, delta) {
        localEqGains[idx] = Math.max(-15, Math.min(15, localEqGains[idx] + delta));
        document.getElementById(`gv${idx}`).innerText = (localEqGains[idx] > 0 ? "+" : "") + localEqGains[idx];
        send(`eqg${idx}`, localEqGains[idx]);
    }

    // --- Логика Баланса ---
    let balCtx, cvs;
    function initBalancePad() {
        cvs = document.getElementById('balCanvas');
        balCtx = cvs.getContext('2d');
        drawBalance(150, 150);
        cvs.addEventListener('pointermove', e => { if(e.buttons) handleBal(e); });
        cvs.addEventListener('pointerdown', handleBal);
    }
    function handleBal(e) {
        const rect = cvs.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        drawBalance(x, y);
        // Маппинг 0..300 в -31..31 (упрощенно)
        let bal = Math.round((x - 150) / 4.8);
        let fad = Math.round((150 - y) / 4.8);
        send('bal_x', bal); // ESP должна будет посчитать плечи LF/RF/LR/RR сама или ждет X/Y
        // Если твоя ESP ждет напрямую аттенюаторы, то логику расчета нужно добавить сюда.
    }
    function drawBalance(x, y) {
        balCtx.clearRect(0, 0, 300, 300);
        balCtx.strokeStyle = "#444";
        balCtx.beginPath(); balCtx.moveTo(150,0); balCtx.lineTo(150,300); balCtx.stroke();
        balCtx.beginPath(); balCtx.moveTo(0,150); balCtx.lineTo(300,150); balCtx.stroke();
        balCtx.fillStyle = "#007bff";
        balCtx.beginPath(); balCtx.arc(x, y, 10, 0, Math.PI*2); balCtx.fill();
    }
    function drawBalanceFromState(lf, rf, lr, rr) {
        // Упрощенная логика: считаем центр по разнице плеч
        let x = 150 + (lf - rf) * 2; 
        let y = 150 + (lr - rr) * 2;
        drawBalance(x, y);
    }
    </script>
</body>
</html>
