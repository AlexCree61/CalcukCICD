<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TDA7416 Control</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #007bff; --text: #fff; --text-sec: #888; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; user-select: none; }
        .header { padding: 15px; background: #1a1a1a; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .status { font-size: 0.8rem; color: #f44336; }
        .status.ok { color: #00e676; }
        .tabs { display: flex; overflow-x: auto; background: #252525; }
        .tab-btn { flex: 1; padding: 15px; background: none; border: none; color: #aaa; font-size: 1rem; cursor: pointer; border-bottom: 2px solid transparent; min-width: 80px; }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: bold; }
        .content { display: none; padding: 20px; padding-bottom: 80px; }
        .content.active { display: block; }
        .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        h3 { margin-top: 0; font-size: 1.1rem; color: #ddd; border-bottom: 1px solid #333; padding-bottom: 5px; }
        label { display: block; margin-bottom: 5px; color: var(--text-sec); font-size: 0.9rem; }
        input[type=range] { width: 100%; height: 6px; background: #444; border-radius: 5px; outline: none; -webkit-appearance: none; margin: 15px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--accent); border-radius: 50%; cursor: pointer; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        select { background: #333; color: white; border: none; padding: 8px; border-radius: 5px; width: 100%; font-size: 1rem; }
        .btn-toggle { background: #333; color: #aaa; padding: 10px 20px; border-radius: 20px; border: 1px solid #444; cursor: pointer; flex: 1; margin: 0 5px; }
        .btn-toggle.active { background: var(--accent); color: white; border-color: var(--accent); }
        .eq-scroll { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; }
        .eq-band { min-width: 60px; text-align: center; background: #252525; padding: 10px; border-radius: 8px; }
        .eq-slider-vert { writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 30px; height: 150px; }
        #balCanvas { background: #2b2b2b; border-radius: 10px; margin: 0 auto; display: block; touch-action: none; border: 2px solid #444; }
        #connectBtn { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <div id="status" class="status">Disconnected</div>
        <button id="connectBtn">Connect</button>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('main')">Main</button>
        <button class="tab-btn" onclick="openTab('eq')">EQ</button>
        <button class="tab-btn" onclick="openTab('bal')">Balance</button>
        <button class="tab-btn" onclick="openTab('adv')">Advanced</button>
    </div>

    <div id="main" class="content active">
        <div class="card">
            <h3>Master Volume</h3>
            <h2 id="volVal" style="text-align: center; color: var(--accent);">-20</h2>
            <input type="range" min="-79" max="15" value="-20" oninput="send('voll', this.value); document.getElementById('volVal').innerText = this.value">
        </div>
        <div class="card">
            <h3>Input Source</h3>
            <div style="display: flex;">
                <button id="btnSrcBT" class="btn-toggle active" onclick="setInput('Bluetooth')">Bluetooth</button>
                <button id="btnSrcUSB" class="btn-toggle" onclick="setInput('USB')">USB</button>
            </div>
        </div>
        <div class="card">
            <h3>Preamp Gain</h3>
            <input type="range" min="0" max="15" value="10" oninput="send('pre', this.value)">
        </div>
        <div class="card">
            <div class="row">
                <h3>Mute</h3>
                <label class="switch">
                    <input type="checkbox" id="muteSw" onchange="send('mute', this.checked ? 0 : 1)" checked>
                    <span>Sound ON</span>
                </label>
            </div>
        </div>
    </div>

    <div id="eq" class="content">
        <div class="eq-scroll" id="eqContainer"></div>
        <div class="card">
            <h3>Subwoofer Config</h3>
            <div class="row"><label>Freq</label><select onchange="send('s_fr', this.value)" id="subFr"><option value="0">Off</option><option value="1">90Hz</option><option value="2">135Hz</option><option value="3">180Hz</option><option value="4">225Hz</option></select></div>
            <div class="row"><label>Q-Factor</label><select onchange="send('s_q', this.value)" id="subQ"><option value="0">3.5</option><option value="1">1.8</option></select></div>
            <div class="row"><label>HP Filter</label><input type="checkbox" id="subHp" onchange="send('s_hp', this.checked?1:0)"></div>
        </div>
    </div>

    <div id="bal" class="content">
        <div class="card"><h3>Subwoofer Gain</h3><input type="range" min="-79" max="15" value="0" oninput="send('s_att', this.value)"></div>
        <div class="card" style="text-align: center;"><h3>Fader / Balance</h3><canvas id="balCanvas" width="300" height="300"></canvas><p style="font-size: 0.8rem; margin-top: 5px;">Drag to adjust</p></div>
    </div>

    <div id="adv" class="content">
        <div class="card">
            <h3>Loudness</h3>
            <div class="row"><label>Enable</label><input type="checkbox" id="lByp" onchange="send('l_byp', this.checked?1:0)"></div>
            <label>Attenuation</label><input type="range" min="0" max="15" value="0" oninput="send('l_att', this.value)">
            <label>Center Freq</label><select onchange="send('l_cen', this.value)" id="lCen"><option value="0">200Hz</option><option value="1">400Hz</option><option value="2">600Hz</option><option value="3">800Hz</option></select>
        </div>
    </div>

    <script>
    // --- ПРОВЕРКА ОШИБОК ---
    window.onerror = function(msg, url, line) {
        alert("Критическая ошибка: " + msg + "\nСтрока: " + line);
        return false;
    };

    // --- ПОЛИФИЛ USB-SERIAL ---
    class USBSerialDevice {
        constructor(device) {
            this.device = device;
            this.interface = 0;
            this.epIn = 0;
            this.epOut = 0;
        }

        async open() {
    await this.device.open();
    if (this.device.configuration === null) await this.device.selectConfiguration(1);

    const iface = this.device.configuration.interfaces.find(i => 
        i.alternates[0].endpoints && i.alternates[0].endpoints.length > 1
    ) || this.device.configuration.interfaces[0];

    this.interface = iface.interfaceNumber;
    await this.device.claimInterface(this.interface);

    const endpoints = iface.alternates[0].endpoints;
    this.epIn = endpoints.find(e => e.direction === 'in').endpointNumber;
    this.epOut = endpoints.find(e => e.direction === 'out').endpointNumber;

    // --- ДОБАВЛЕНО: Инициализация для CP2102 / CH340 ---
    try {
        // Устанавливаем Baud Rate 9600 (специфично для многих USB чипов)
        await this.device.controlTransferOut({
            requestType: 'vendor', recipient: 'device',
            request: 0x1E, value: 0x00, index: 0x00 // Сброс порта
        });
        
        // Включаем DTR и RTS (высокий уровень), чтобы ESP32 вышла из режима сброса
        await this.device.controlTransferOut({
            requestType: 'vendor', recipient: 'device',
            request: 0x07, value: 0x0303, index: this.interface
        });
    } catch (e) {
        console.log("Вендорная инициализация не поддерживается, пропускаем...");
    }
            this.readable = {
                getReader: () => ({
                    read: async () => {
                        const result = await this.device.transferIn(this.epIn, 64);
                        return { value: new Uint8Array(result.data.buffer), done: false };
                    },
                    releaseLock: () => {}
                })
            };

            this.writable = {
                getWriter: () => ({
                    write: async (data) => {
                        await this.device.transferOut(this.epOut, data);
                    },
                    releaseLock: () => {}
                })
            };
        }
    }

    // --- ЛОГИКА ---
    let port, writer;
    let isSyncing = false;

    // Инициализация при загрузке
    window.addEventListener('load', () => {
        generateEQ();
        initBalancePad();
    });

    // ОБРАБОТЧИК КНОПКИ (Используем ID напрямую)
    document.getElementById('connectBtn').onclick = async function() {
        try {
            console.log("Запрос USB...");
            const device = await navigator.usb.requestDevice({ filters: [] });
            port = new USBSerialDevice(device);
            
            await port.open();
            
            document.getElementById('status').innerText = "Connected";
            document.getElementById('status').className = "status ok";
            this.style.display = 'none';

            writer = port.writable.getWriter();
            setTimeout(() => sendRaw("DUMP"), 1000);
            readLoop();
        } catch (e) {
            alert("Ошибка при подключении: " + e.message);
        }
    };

    async function readLoop() {
        const reader = port.readable.getReader();
        try {
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                const text = new TextDecoder().decode(value);
                processIncoming(text);
            }
        } catch (e) {
            console.error("Чтение прервано", e);
        }
    }

    let serialBuffer = "";
    function processIncoming(text) {
        console.log("Пришло из ESP:", text);
        serialBuffer += text;
        let lines = serialBuffer.split('\n');
        serialBuffer = lines.pop();
        for (let line of lines) {
            if (line.startsWith("STATE:")) parseState(line);
        }
    }

    function parseState(line) {
        isSyncing = true;
        try {
            const raw = line.replace("STATE:", "").replace(",END", "").trim();
            const d = raw.split(",").map(Number);
            if (document.getElementById('volVal')) document.getElementById('volVal').innerText = d[0];
            const volSlider = document.querySelector('input[oninput*="voll"]');
            if (volSlider) volSlider.value = d[0];
        } catch(e) {}
        isSyncing = false;
    }

    async function send(key, val) {
        if (isSyncing) return;
        sendRaw(`${key}:${Math.floor(val)}`);
    }

    async function sendRaw(text) {
    if (writer) {
        try {
            // Добавляем \r\n для надежности
            const data = new TextEncoder().encode(text + "\r\n");
            await writer.write(data);
            console.log("Отправлено:", text);
        } catch(e) {
            console.error("Ошибка отправки:", e);
        }
    } else {
        console.warn("Writer не готов!");
    }
}

    // UI
    function openTab(id) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        // Находим кнопку, которая была нажата, по тексту или ID
        if (window.event) {
            window.event.target.classList.add('active');
        }
    }

    function setInput(type, transmit=true) {
        document.getElementById('btnSrcBT').className = `btn-toggle ${type==='Bluetooth'?'active':''}`;
        document.getElementById('btnSrcUSB').className = `btn-toggle ${type==='USB'?'active':''}`;
        if (transmit) send('ins', type === 'Bluetooth' ? 2 : 0);
    }

    function generateEQ() {
        const container = document.getElementById('eqContainer');
        if (!container) return;
        container.innerHTML = '';
        for (let i = 0; i < 7; i++) {
            const div = document.createElement('div');
            div.className = 'eq-band';
            div.innerHTML = `
                <div style="font-size:0.7rem; margin-bottom:5px;">Band ${i+1}</div>
                <input type="range" class="eq-slider-vert" id="eqg${i}" min="-15" max="15" value="0" oninput="send('eqg${i}', this.value)">
            `;
            container.appendChild(div);
        }
    }

    function initBalancePad() {
        const canvas = document.getElementById('balCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const draw = () => {
            ctx.clearRect(0,0,300,300);
            ctx.strokeStyle = '#555';
            ctx.strokeRect(150,0,0,300); ctx.strokeRect(0,150,300,0);
        };
        draw();
    }
    </script>
    

</body>
</html>
